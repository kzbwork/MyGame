<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <title>websocket client</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript">
        var start = function () {
            var inc = document.getElementById('incomming');
            var wsImpl = window.WebSocket || window.MozWebSocket;
            var input = document.getElementById('sendText');

            inc.innerHTML += "登录到服务器<br/>";
            window.ws = new wsImpl('ws://192.168.157.166:7181/');

            // when data is comming from the server, this metod is called
            ws.onmessage = function (evt) {
                inc.innerHTML += evt.data + '<br/>';
            };

            // when the connection is established, this method is called
            ws.onopen = function (a) {
                inc.innerHTML += '登录成功<br/>';
            };

            // when the connection is closed, this method is called
            ws.onclose = function () {
                inc.innerHTML += '已退出<br/>';
            }

            //$(this).keydown(function (event) {
            //    if (event.keyCode == 13) {
            //        e.preventDefault();
            //        var val = input.value;
            //        ws.send(val);
            //        input.value = "";
            //    }
            //});

            $("#send").on("click", function (e) {
                e.preventDefault();
                var val = input.value;
                ws.send(val);
                input.value = "";
            });

            $('#sendText').bind('keyup', function (event) {
                if (event.keyCode == "13") {
                    //回车执行查询
                    $("#send").click();
                }
            });

            //form.addEventListener('keydown', function (e) {
            //    if (event.keyCode == 13) {
            //        event.preventDefault();
            //        var val = input.value;
            //        ws.send(val);
            //        input.value = "";
            //    }
            //});
        }

        function login()
        {
            var name = $("#name").val();
            if (name != "") {
                $.ajax({
                    type: "POST",
                    datatype: "json",
                    url: "http://" + document.domain + ":12606/FleckHandler.ashx?name="+name+"",
                    success: function (d) {
                        start();
                        $('#myModal').modal('hide')
                    }
                });
            }
            else {
                alert("请输入用户名");
                return;
            }
        }
        $(function () {
            $('#myModal').modal('show')
        });
    </script>
</head>
<body>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">
                        登录到聊天室
                    </h4>
                </div>
                <div class="modal-body">
                    <input type="text" id="name" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="login()">
                        登录
                    </button>
                </div>
            </div>
        </div>
    </div>
    <pre id="incomming" style="width:80%;height:600px;margin:0 auto"></pre>
    <div class="form-inline" style="width:80%;height:200px;margin:0 auto;padding:0;">
        <input class="form-control" type="text" id="sendText" placeholder="Text to send" style="width:80%"/>
        <button type="button" class="btn btn-primary" id="send">
            发送
        </button>
    </div>
</body>
</html>